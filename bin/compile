#!/bin/bash

set -e

# Install dependencies
apt-get update && apt-get install -y \
  autoconf \
  automake \
  build-essential \
  git \
  pkg-config \
  wget \
  libglib2.0-dev \
  libheif-dev \
  libde265-dev \
  x265

# Install libde265
cd /tmp
wget https://github.com/strukturag/libde265/releases/download/v1.0.8/libde265-1.0.8.tar.gz
tar -xzf libde265-1.0.8.tar.gz
cd libde265-1.0.8
./autogen.sh
./configure --prefix=/app/local
make
make install

# Install x265
cd /tmp
wget https://bitbucket.org/multicoreware/x265_git/downloads/x265_3.5.tar.gz
tar -xzf x265_3.5.tar.gz
cd x265_3.5/build/linux
cmake -DCMAKE_INSTALL_PREFIX=/app/local ../../source
make
make install

# Install libheif
cd /tmp
wget https://github.com/strukturag/libheif/releases/download/v1.12.0/libheif-1.12.0.tar.gz
tar -xzf libheif-1.12.0.tar.gz
cd libheif-1.12.0
./autogen.sh
./configure --prefix=/app/local --with-libde265 --with-x265
make
make install

# Clean up
rm -rf /tmp/libde265-1.0.8
rm -rf /tmp/x265_3.5
rm -rf /tmp/libheif-1.12.0

echo "Libraries installed"
